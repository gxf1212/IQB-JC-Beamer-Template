% ============================================================
% IQB Journal Club Beamer Theme
% 基于 Metropolis 主题的学术演示模板
% Version: 2.0 | Date: 2025-10-23
% ============================================================

\NeedsTeXFormat{LaTeX2e}
\mode<presentation>

\ProvidesPackage{beamerthemeiqb}[2025/10/23 v2.0 IQB Journal Club Beamer Theme]

% ============================================================
% Requirements - 依赖包
% ============================================================
\RequirePackage{tikz}
\RequirePackage{graphicx}
\RequirePackage{calc}
\RequirePackage{etoolbox}
\RequirePackage{setspace}  % 行间距控制
\RequirePackage{fontawesome5}  % 学术图标和社交媒体图标
\RequirePackage{xeCJK}       % 中文支持（需要 XeLaTeX）
\RequirePackage{ifplatform}  % 平台检测，用于跨平台字体配置
\RequirePackage{ifthen}      % 条件判断，用于日期格式切换

% ============================================================
% Theme Options - 主题选项
% ============================================================
% Header display option
\newif\ifbeamer@iqb@showheader
\beamer@iqb@showheadertrue

\DeclareOptionBeamer{noheader}{\beamer@iqb@showheaderfalse}


\newif\ifbeamer@iqb@tocnumbered
\beamer@iqb@tocnumberedfalse  % Table of contents numbering option (default: disabled)

\DeclareOptionBeamer{tocnumbered}{\beamer@iqb@tocnumberedtrue}

\ProcessOptionsBeamer

% ============================================================
% Custom Metadata Fields - 自定义元数据字段
% ============================================================
\newcommand{\advisor}[1]{\gdef\@advisor{#1}}
\newcommand{\stuid}[1]{\gdef\@stuid{#1}}
\newcommand{\major}[1]{\gdef\@major{#1}}
\newcommand{\college}[1]{\gdef\@college{#1}}
\newcommand{\grade}[1]{\gdef\@grade{#1}}

\gdef\@advisor{}
\gdef\@stuid{}
\gdef\@major{}
\gdef\@college{}
\gdef\@grade{}

% ============================================================
% Date Format - 日期格式设置
% ============================================================
\newcommand{\dateformat}[1]{
  \ifthenelse{\equal{#1}{zh}}{
    \renewcommand{\today}{\the\year 年 \the\month 月 \the\day 日}
  }{
    \renewcommand{\today}{\the\day\ \ifcase\the\month\or January\or February\or March\or April\or May\or June\or July\or August\or September\or October\or November\or December\fi\ \the\year}
  }
}






% ============================================================
% Font Configuration - 字体配置（跨平台）
% ============================================================
\ifwindows
  
  \setCJKmainfont[BoldFont=SimHei]{SimSun}
  \setCJKsansfont{SimHei}
\else
  \ifmacosx
    
    \setCJKmainfont[BoldFont=STHeiti]{Songti SC}
    \setCJKsansfont{PingFang SC}
  \else
    
    \setCJKmainfont[BoldFont=Noto Sans CJK SC]{Noto Serif CJK SC}
    \setCJKsansfont{Noto Sans CJK SC}
  \fi
\fi


% ============================================================
% Document Begin Hook
% ============================================================

\AtBeginDocument{
  \ifbeamer@iqb@tocnumbered
    \setbeamertemplate{section in toc}[sections numbered]
    \setbeamertemplate{subsection in toc}[subsections numbered]
  \else
    \setbeamertemplate{section in toc}[default]
    \setbeamertemplate{subsection in toc}[default]
  \fi
}





\newcommand{\iqbinstitute}{Institute of Quantitative Biology}
\newcommand{\setiqbinstitute}[1]{\renewcommand{\iqbinstitute}{#1}}


\newcommand{\iqblogopath}{../theme/images/header.png}
\newcommand{\setiqblogopath}[1]{\renewcommand{\iqblogopath}{#1}}








% ============================================================
% Color Definitions - 颜色定义
% ============================================================
\definecolor{iqbblue}{RGB}{0, 51, 102}        % IQB primary blue
\definecolor{iqbdarkblue}{RGB}{0, 26, 51}    % Darker blue for contrast
\definecolor{iqblightblue}{RGB}{74, 144, 226} % Light blue for accents
\definecolor{iqbgray}{RGB}{85, 85, 85}        % Text gray
\definecolor{iqblightgray}{RGB}{240, 240, 240} % Light background gray 


\definecolor{iqborange}{RGB}{255, 107, 53}   % Orange for warnings/highlights
\definecolor{iqbgreen}{RGB}{46, 204, 113}    % Green for success/emphasis
\definecolor{iqbred}{RGB}{231, 76, 60}       % Red for errors/caution

% ============================================================
% Beamer Color Configuration - Beamer 颜色配置
% ============================================================
\setbeamercolor{normal text}{fg=black, bg=white}
\setbeamercolor{frametitle}{fg=iqbblue}  
\setbeamercolor{title}{fg=iqbblue}
\setbeamercolor{subtitle}{fg=iqbgray}
\setbeamercolor{author}{fg=iqbgray}
\setbeamercolor{date}{fg=iqbgray}
\setbeamercolor{footline}{fg=iqbgray, bg=white}
\setbeamercolor{block title}{fg=white, bg=iqbblue}
\setbeamercolor{block body}{fg=black, bg=iqblightgray}











\setbeamerfont{title}{size=\Large, series=\bfseries}  
\setbeamerfont{subtitle}{size=\normalsize}  
\setbeamerfont{author}{size=\normalsize}  
\setbeamerfont{date}{size=\normalsize}  
\setbeamerfont{frametitle}{size=\large, series=\bfseries}  
\setbeamerfont{footline}{size=\tiny}  
\setbeamerfont{block title}{size=\scriptsize, series=\bfseries}  
\setbeamerfont{normal text}{size=\footnotesize}  
\setbeamerfont{itemize/enumerate body}{size=\footnotesize}  
\setbeamerfont{itemize/enumerate subbody}{size=\footnotesize}  
\setbeamerfont{caption}{size=\scriptsize}  



\AtBeginEnvironment{frame}{
  \ifbeamer@plainframe\else
    \footnotesize
  \fi
}






\setbeamertemplate{navigation symbols}{}











\setstretch{1.2}  


\setlength{\leftmargini}{0.9em}  
\setlength{\itemsep}{0.1ex}  
\setlength{\parsep}{0pt}  
\setlength{\parskip}{0pt}  


% ============================================================
% Document Begin Hook
% ============================================================

\AtBeginDocument{
  \setlength{\abovedisplayskip}{3pt}
  \setlength{\belowdisplayskip}{3pt}
  \setlength{\abovedisplayshortskip}{0pt}
  \setlength{\belowdisplayshortskip}{2pt}
}


\newcommand{\tinysep}{\par\smallskip}    
\newcommand{\blocksep}{\par\medskip}     
\newcommand{\bigsep}{\par\bigskip}       


\defbeamertemplate*{title page}{iqb}[1][]
{
  \vbox{}
  \vfill
  \begingroup
    \centering
    \begin{beamercolorbox}[sep=8pt,center,#1]{title}
      \usebeamerfont{title}\inserttitle\par
      \ifx\insertsubtitle\@empty
      \else
        \vskip0.25em
        {\usebeamerfont{subtitle}\usebeamercolor[fg]{subtitle}\insertsubtitle\par}
      \fi
    \end{beamercolorbox}
    \vskip0.8em\par
    \begin{beamercolorbox}[sep=4pt,center,#1]{author}
      \usebeamerfont{author}\insertauthor
    \end{beamercolorbox}
    \vskip0.2em
    \begin{beamercolorbox}[sep=4pt,center,#1]{institute}
      \usebeamerfont{author}\insertinstitute
    \end{beamercolorbox}
    
    \ifx\@stuid\empty\else
      \vskip0.2em
      \begin{beamercolorbox}[sep=2pt,center,#1]{author}
        \usebeamerfont{author}瀛﹀彿锛歕@stuid
      \end{beamercolorbox}
    \fi
    \ifx\@major\empty\else
      \vskip0.2em
      \begin{beamercolorbox}[sep=2pt,center,#1]{author}
        \usebeamerfont{author}涓撲笟锛歕@major
      \end{beamercolorbox}
    \fi
    \ifx\@grade\empty\else
      \vskip0.2em
      \begin{beamercolorbox}[sep=2pt,center,#1]{author}
        \usebeamerfont{author}骞寸骇锛歕@grade
      \end{beamercolorbox}
    \fi
    \ifx\@advisor\empty\else
      \vskip0.2em
      \begin{beamercolorbox}[sep=2pt,center,#1]{author}
        \usebeamerfont{author}瀵煎笀锛歕@advisor
      \end{beamercolorbox}
    \fi
    \vskip0.5em
    \begin{beamercolorbox}[sep=4pt,center,#1]{date}
      \usebeamerfont{date}\insertdate
    \end{beamercolorbox}
  \endgroup
  \vfill
}


\setbeamertemplate{blocks}[rounded][shadow=false]


\setbeamercolor{itemize item}{fg=iqbblue}
\setbeamercolor{itemize subitem}{fg=iqbblue}
\setbeamercolor{itemize subsubitem}{fg=iqbblue}
\setbeamertemplate{itemize item}{$\bullet$}
\setbeamertemplate{itemize subitem}{$\circ$}
\setbeamertemplate{itemize subsubitem}{$-$}


\setbeamertemplate{caption}{
  \raggedright
  \insertcaption\par
}






\defbeamertemplate*{frametitle}{iqb}[1][]
{
  
  \begin{tikzpicture}[remember picture,overlay]
    \node[anchor=north west,inner sep=0pt] at ($(current page.north west) + (1.5cm,-0.35cm)$) {
      \begin{minipage}{0.62\paperwidth}
        {\usebeamerfont{frametitle}\usebeamercolor[fg]{frametitle}\textbf{\insertframetitle}}
        \ifx\insertframesubtitle\@empty
        \else
          \par\vskip0.05cm
          {\usebeamerfont{framesubtitle}\usebeamercolor[fg]{subtitle}\insertframesubtitle}
        \fi
      \end{minipage}
    };
  \end{tikzpicture}
  \vskip0.05cm  
}



\providecommand{\iqbheaderimage}{theme/images/header.png}

\defbeamertemplate*{headline}{iqb}
{
  \ifbeamer@iqb@showheader
    
    
    \ifbeamer@plainframe
      
    \else
      \begin{tikzpicture}[remember picture,overlay]
        \node[anchor=north,inner sep=0pt] at (current page.north) {
          
          \includegraphics[width=\paperwidth,keepaspectratio]{\iqbheaderimage}
        };
      \end{tikzpicture}
      \vskip0.65cm  
    \fi
  \fi
}


\newcommand{\iqbsection}{}  
\newcommand{\setsection}[1]{\renewcommand{\iqbsection}{#1}}



\newcommand{\iqb@footleft}{\textbf{\iqbinstitute}}
\newcommand{\iqb@footcenter}{\iqbsection}
\newcommand{\iqb@ftotal}{\inserttotalframenumber}
\newcommand{\iqb@footright}{\insertframenumber{} / \iqb@ftotal}






\newcommand{\iqbfootlineconfig}[4]{
  
  \def\@tmpa{#1}
  \ifthenelse{\equal{\@tmpa}{title}}{\renewcommand{\iqb@footcenter}{\insertshortframetitle}}{\renewcommand{\iqb@footcenter}{\iqbsection}}
  
  \def\@tmpb{#2}
  \ifthenelse{\equal{\@tmpb}{ratio}}{\renewcommand{\iqb@footright}{\insertframenumber{} / \iqb@ftotal}}{
    \ifthenelse{\equal{\@tmpb}{pageofy}}{\renewcommand{\iqb@footright}{Page~\insertframenumber/\iqb@ftotal}}{
      \ifthenelse{\equal{\@tmpb}{zhpageofy}}{\renewcommand{\iqb@footright}{第\insertframenumber/\iqb@ftotal~页}}{
        \renewcommand{\iqb@footright}{\insertframenumber{} / \iqb@ftotal}
      }
    }
  }
  
  \def\@tmpc{#3}
  \ifthenelse{\equal{\@tmpc}{default}}{\renewcommand{\iqb@footleft}{\textbf{\iqbinstitute}}}{\renewcommand{\iqb@footleft}{#3}}
  
  \def\@tmpd{#4}
  \ifthenelse{\equal{\@tmpd}{auto}}{}{\renewcommand{\iqb@ftotal}{#4}}
}













\newcommand{\iqbfootline}[3]{
  \iqbfootlineconfig{#2}{#3}{#1}{auto}
}



\newcommand{\iqbfoottotal}[1]{\renewcommand{\iqb@ftotal}{#1}}




\defbeamertemplate*{footline}{iqb}
{
  \ifbeamer@plainframe
    
  \else
    \vskip-8pt
    
    \begin{beamercolorbox}[wd=\paperwidth,ht=1.5pt,dp=0pt,sep=0pt]{structure}
      \color{iqbblue}\rule{\paperwidth}{1.5pt}
    \end{beamercolorbox}
    \vskip2pt
    
    \leavevmode
    \hbox{
    \begin{beamercolorbox}[wd=.32\paperwidth,ht=1.8ex,dp=0.6ex,left]{footline}
      \hspace{0.4em}\usebeamerfont{footline}\textcolor{iqbblue}{\iqb@footleft}
    \end{beamercolorbox}
    \begin{beamercolorbox}[wd=.32\paperwidth,ht=1.8ex,dp=0.6ex,center]{footline}
      \usebeamerfont{footline}\iqb@footcenter
    \end{beamercolorbox}
    \begin{beamercolorbox}[wd=.32\paperwidth,ht=1.8ex,dp=0.6ex,right]{footline}
      \usebeamerfont{footline}\iqb@footright\hspace{0.4em}
    \end{beamercolorbox}}
    \vskip2pt
  \fi
}






\setlength{\columnsep}{1em}


\newcommand{\iqbtwocolumn}[2]{
  \begin{columns}[T]
    \begin{column}{0.48\textwidth}
      #1
    \end{column}
    \hfill
    \begin{column}{0.48\textwidth}
      #2
    \end{column}
  \end{columns}
}

\newcommand{\iqbthreecolumn}[3]{
  \begin{columns}[T]
    \begin{column}{0.31\textwidth}
      #1
    \end{column}
    \begin{column}{0.31\textwidth}
      #2
    \end{column}
    \begin{column}{0.31\textwidth}
      #3
    \end{column}
  \end{columns}
}







\newcommand{\iqbfontsizemode}[1]{
  \ifthenelse{\equal{#1}{small}}{
    
    \setbeamerfont{normal text}{size=\scriptsize}              
    \setbeamerfont{itemize/enumerate body}{size=\scriptsize}  
    \setbeamerfont{itemize/enumerate subbody}{size=\tiny}     
    \setbeamerfont{frametitle}{size=\normalsize, series=\bfseries}  
    \setbeamerfont{block title}{size=\tiny}                   
    \setbeamerfont{caption}{size=\tiny}                       
  }{
    
    \setbeamerfont{normal text}{size=\footnotesize}           
    \setbeamerfont{itemize/enumerate body}{size=\footnotesize}  
    \setbeamerfont{itemize/enumerate subbody}{size=\footnotesize}  
    \setbeamerfont{frametitle}{size=\large, series=\bfseries}  
    \setbeamerfont{block title}{size=\scriptsize, series=\bfseries}  
    \setbeamerfont{caption}{size=\scriptsize}                 
  }
}







\mode<all>



